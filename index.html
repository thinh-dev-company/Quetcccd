// Lắng nghe sự kiện thay đổi file
fileInput.addEventListener("change", (event) => {
    const fileInput = document.getElementById("fileInput");
    if (fileInput.files.length === 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Chưa chọn tệp!',
            text: 'Vui lòng chọn một tệp ảnh để quét.',
            confirmButtonText: 'OK'
        });
        return;
    }

    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.readAsDataURL(file);

    // Hiển thị hiệu ứng loading khi bắt đầu quét
    Swal.fire({
        title: 'Đang quét ảnh...',
        text: 'Vui lòng chờ trong giây lát!',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    reader.onload = function () {
        Tesseract.recognize(
            reader.result,
            'vie', // Ngôn ngữ tiếng Việt
            {
                logger: info => console.log(info) // Log tiến trình
            }
        ).then(({ data: { text } }) => {
            console.log("Kết quả OCR:", text);

            // Hàm tìm kiếm số CCCD dựa vào chuỗi số liên tục
            function extractCitizenId(text) {
                const idRegex = /\b\d{12}\b/; // Tìm kiếm chuỗi 12 chữ số
                const match = text.match(idRegex);
                return match ? match[0] : null;
            }

            // Trích xuất số CCCD
            const citizenId = extractCitizenId(text);

            // Đóng hiệu ứng loading
            Swal.close();

            // Kiểm tra nếu không tìm thấy CCCD
            if (!citizenId) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi nhận diện!',
                    text: 'Không tìm thấy số CCCD trong ảnh. Vui lòng thử lại.',
                    confirmButtonText: 'OK'
                });
                fileInput.value = "";
                return;
            }

            // Gán part1 và kiểm tra với danh sách user
            part1 = citizenId;

            // Kiểm tra xem part1 có trong danh sách user không
            var user = users.find(u => u.cccd === part1);

            if (!user) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Không hợp lệ!',
                    text: 'Hiện tại đợt khảo sát đã kết thúc hoặc cử tri không có trong danh sách lấy ý kiến!',
                    confirmButtonText: 'OK'
                });
                return;
            }

            // Nếu hợp lệ, hiển thị form khảo sát
            document.getElementById("greeting").innerHTML = `
                        <strong>Xin chào ${user.ten}!</strong><br>
                        <strong>Số CCCD:</strong> ${user.cccd}<br>
                        <strong>Địa chỉ:</strong> ${user.diaChi}<br>
                        <strong>Ngày sinh:</strong> ${user.ngaySinh}
                    `;
            formContainer.style.display = "block";
            showForm();
            loadSavedAnswers(part1);
            fileInput.value = "";


        }).catch(err => {
            console.error("Lỗi trong quá trình nhận diện:", err);

            // Đóng hiệu ứng loading nếu xảy ra lỗi
            Swal.close();

            Swal.fire({
                icon: 'error',
                title: 'Lỗi xử lý ảnh!',
                text: 'Có lỗi xảy ra khi quét CCCD, vui lòng thử lại.',
                confirmButtonText: 'OK'
            });
        });
    };
});
